name: Build client exe and docker relay server

on:
  pull_request:

jobs:
  build-client-ubuntu:
    name: Build moq-rust/moq-pub client on ubuntu
    runs-on: ubuntu-latest
    steps: 
      -
        name: Checkout repo
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - 
        name: Setup Rust
        uses:  hecrj/setup-rust-action@v1
        with:
          rust-version: stable
      -
        name: Build 
        working-directory: moq-server/moq-pub
        run: cargo build --release

  build-client-windows:
    name: Build moq-rust/moq-pub code on windows
    runs-on: windows-latest
    steps: 
      -
        name: Checkout repo
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - 
        name: Setup Rust
        uses:  hecrj/setup-rust-action@v1
        with:
          rust-version: stable
      -
        name: Build 
        working-directory: moq-server/moq-pub
        run: cargo build --release

  build-relay-ubuntu:
    name: Build moq-rust relay on ubuntu
    runs-on: ubuntu-latest
    steps: 
      -
        name: Checkout repo
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - 
        name: Setup Rust
        uses:  hecrj/setup-rust-action@v1
        with:
          rust-version: stable
      -
        name: Build 
        working-directory: moq-server
        run: cargo build --release

  build-docker-relay:
      name: Build relay server for moq-rs
      runs-on: ubuntu-latest
      steps:
        -
          name: Checkout repo
          uses: actions/checkout@v3
        - 
          name: Setup Docker Buildx
          uses: docker/setup-buildx-action@v2
        - 
          name: Build Docker image
          uses: docker/build-push-action@v4
          with:
            context: ./
            file: docker/base/Dockerfile
            push: false
            load: true
            tags: warp:relay
